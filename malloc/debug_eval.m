clear;
clc;

NUM_STAGES = 20;
PARAM_GRANULARITY = 256;
PARAM_NUMAPPS = 128;
PARAM_EXPID = 1;
PARAM_WORKLOAD = 'cache';
PARAM_FIT = 'wf';

data_alloctime = readtable(sprintf( ...
    'stats_g%d_n%d_%s_%s/%d/alloctime.csv', ...
    PARAM_GRANULARITY, ...
    PARAM_NUMAPPS, ...
    PARAM_WORKLOAD, ...
    PARAM_FIT, ...
    PARAM_EXPID ...
));

data_utilization = readtable(sprintf( ...
    'stats_g%d_n%d_%s_%s/%d/utilization.csv', ...
    PARAM_GRANULARITY, ...
    PARAM_NUMAPPS, ...
    PARAM_WORKLOAD, ...
    PARAM_FIT, ...
    PARAM_EXPID ...
));

figure;
subplot(1, 2, 1);
plot(table2array(data_alloctime) * 1E3, '-x');
xlabel('App #');
ylabel('Allocation Time (ms)');
set(gca, 'FontSize', 16);
grid on;
subplot(1, 2, 2);
plot(table2array(data_utilization), '-x');
xlabel('App #');
ylabel('Utilization');
set(gca, 'FontSize', 16);
grid on;

set(gcf, 'Position', get(0, 'Screensize'));
saveas(gcf, sprintf( ...
    'debug_allocation_sequence_time_util_g%d_n%d_e%d_%s_%s.png', ...
    PARAM_GRANULARITY, ...
    PARAM_NUMAPPS, ...
    PARAM_EXPID, ...
    PARAM_WORKLOAD, ...
    PARAM_FIT ...
));

data_stageidx = readtable(sprintf( ...
    'stats_g%d_n%d_%s_%s/%d/stages.csv', ...
    PARAM_GRANULARITY, ...
    PARAM_NUMAPPS, ...
    PARAM_WORKLOAD, ...
    PARAM_FIT, ...
    PARAM_EXPID ...
));

for i = 1:size(data_stageidx, 1)
    for j = 1:size(data_stageidx, 2)
        if isnan(data_stageidx{i,j})
            data_stageidx{i,j} = -1;
        end
    end
end

stageidx = unique(data_stageidx, 'rows');

% key_stageidx = data_stageidx{ : , 1} * 10 + data_stageidx{ : , 2};
key_stageidx = zeros(1, size(data_stageidx, 1));
for i = 1:length(key_stageidx)
    for j = 1:size(stageidx, 1)
        if sum(data_stageidx{i, : } ~= stageidx{j, : }) == 0
            key_stageidx(i) = j;
        end
    end
end

cost_current = zeros(1, NUM_STAGES);
cost_series = zeros(NUM_STAGES, PARAM_NUMAPPS);
for i = 1:size(data_stageidx, 1)
    for j = 1:size(data_stageidx, 2)
        idx = data_stageidx{i, j};
        if idx < 0
            continue;
        end
        cost_current(idx + 1) = cost_current(idx + 1) + 1;
    end
    for j = 1:NUM_STAGES
        cost_series(j, i) = cost_current(j);
    end
end

used_stages = find(cost_current);

figure;

subplot(2, 2, 1);
for i = 1:length(used_stages)
    stage_idx = used_stages(i);
    plot(cost_series(stage_idx, : ), '-o');
    hold on;
end
xlabel('App #');
ylabel('Occupancy');
lgd = legend(cellstr(num2str(used_stages', 'N=%-d')));
lgd.Location = 'northwest';
set(gca, 'FontSize', 16);
grid on;

data_numblocks = readtable(sprintf( ...
    'stats_g%d_n%d_%s_%s/%d/numblocks.csv', ...
    PARAM_GRANULARITY, ...
    PARAM_NUMAPPS, ...
    PARAM_WORKLOAD, ...
    PARAM_FIT, ...
    PARAM_EXPID ...
));

subplot(2, 2, 2);
plot(data_numblocks{ : , 1}, '-o');
xlabel('App #');
ylabel('# Allocation Blocks');
set(gca, 'FontSize', 16);
grid on;

% xlim([65 75]);

subplot(2, 2, 3);
plot(key_stageidx, '-o');
yticks(1:size(stageidx, 1));
yticklabels(cellstr(num2str(table2array(stageidx))));
xlabel('App #');
ylabel('Allocation');
set(gca, 'FontSize', 16);
grid on;

data_reallocations = readtable(sprintf( ...
    'stats_g%d_n%d_%s_%s/%d/costs.csv', ...
    PARAM_GRANULARITY, ...
    PARAM_NUMAPPS, ...
    PARAM_WORKLOAD, ...
    PARAM_FIT, ...
    PARAM_EXPID ...
));

subplot(2, 2, 4);
plot(data_reallocations{ : , 1}, '-x');
xlabel('App #');
ylabel('Reallocations');
set(gca, 'FontSize', 16);
grid on;

set(gcf, 'Position', get(0, 'Screensize'));
saveas(gcf, sprintf( ...
    'debug_allocation_sequence_g%d_n%d_e%d_%s_%s.png', ...
    PARAM_GRANULARITY, ...
    PARAM_NUMAPPS, ...
    PARAM_EXPID, ...
    PARAM_WORKLOAD, ...
    PARAM_FIT ...
));

num_apps_actual = size(data_numblocks, 1);

allocated_proportions = zeros(num_apps_actual, num_apps_actual);
fairness = zeros(1, num_apps_actual);
for i = 1:num_apps_actual
    data_allocmat = readtable(sprintf( ...
        'stats_g%d_n%d_%s_%s/%d/allocations/allocmatrix_%d.csv', ...
        PARAM_GRANULARITY, ...
        PARAM_NUMAPPS, ...
        PARAM_WORKLOAD, ...
        PARAM_FIT, ...
        PARAM_EXPID, ...
        i - 1 ...
    ));
    allocmatrix = table2array(data_allocmat);
    [proportions, fairnessIndex] = getAllocatedProportions(allocmatrix);
    allocated_proportions(i,  1:length(proportions) ) = proportions;
    fairness(i) = fairnessIndex;
end

figure;

subplot(2, 1, 1);
boxplot(allocated_proportions');
xlabel('Allocation #');
ylabel('Proportion of Total Allocated');
set(gca, 'FontSize', 16);
grid on;

subplot(2, 1, 2);
plot(fairness, '-x');
xlabel('Allocation #');
ylabel('Fairness Index');
set(gca, 'FontSize', 16);
grid on;

set(gcf, 'Position', get(0, 'Screensize'));
saveas(gcf, sprintf( ...
    'debug_allocation_sequence_fairness_g%d_n%d_e%d_%s_%s.png', ...
    PARAM_GRANULARITY, ...
    PARAM_NUMAPPS, ...
    PARAM_EXPID, ...
    PARAM_WORKLOAD, ...
    PARAM_FIT ...
));